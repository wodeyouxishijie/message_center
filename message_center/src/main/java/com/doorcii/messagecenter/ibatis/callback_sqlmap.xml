<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="apps">
	<typeAlias alias="callbackDO" type="com.doorcii.apps.pojo.CallbackDO" /> 
	<resultMap id="apps.callbackDO" class="callbackDO" >
		<result column="ID" property="id"/>
		<result column="TARGET_KEY" property="targetKey"/>
		<result column="TYPE_ID" property="typeId"/>
		<result column="SCORES" property="scores"/>
		<result column="CALLBACK" property="callback"/>
		<result column="USER_NAME" property="userName"/>
		<result column="RECORD_STATUS" property="recordStatus"/>
		<result column="GMT_CREATE" property="gmtCreate"/>
		<result column="GMT_MODIFIED" property="gmtModified"/>
	</resultMap>
	
	<resultMap id="apps.commentDO" class="commentDO" >
		<result column="AVG_SCORE" property="averageCount" nullValue="0"/>
		<result column="USER_COUNT" property="userCount"/>
	</resultMap>
	
	<sql id="apps.callback_record_columns">
		ID,TARGET_KEY,TYPE_ID,SCORES,CALLBACK,USER_NAME,RECORD_STATUS,GMT_CREATE,GMT_MODIFIED
	</sql>
    <insert id="apps.callback_insert">
		INSERT INTO CALLBACK(<include refid="apps.callback_record_columns"/>) 
		VALUES(#id#,
		#targetKey#,
		#typeId#,
		#scores#,
		#callback#,
		#userName#,
		#recordStatus#,
		NOW(),
		NOW())
		<selectKey resultClass="long" keyProperty="id">   
             SELECT LAST_INSERT_ID() AS ID   
        </selectKey>   
    </insert>
    <select id="apps.queryCallbackDO" >
    	SELECT <include refid="apps.callback_record_columns"/>
    	FROM CALLBACK WHERE TARGET_KEY=#targetKey# AND TYPE_ID=#typeId# 
    	<isNotNull property="status">
    		AND RECORD_STATUS=#status#
    	</isNotNull>
    	AND USER_NAME=#phone# LIMIT 1
    </select>
</sqlMap>